<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Richdale AI - Image Compare</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4A90E2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Image Compare">
    <meta name="description" content="Compare images with a smooth slider interface">
    
    <!-- PWA Links -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon192.png">
    <link rel="apple-touch-icon" href="icon192.png">
    <style>
        :root {
            --primary-color: #4A90E2;
            --accent-color: #FF6B6B;
            --background-color: #ffffff;
            --text-color: #2C3E50;
            --control-bg: #F7F9FC;
            --shadow-color: rgba(74, 144, 226, 0.1);
            --gradient-start: #4A90E2;
            --gradient-end: #357ABD;
        }

        [data-theme="dark"] {
            --background-color: #1a1a1a;
            --text-color: #ffffff;
            --control-bg: #2d2d2d;
            --shadow-color: rgba(74, 144, 226, 0.2);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background: var(--background-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .brand-header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .brand-logo {
            font-size: 2.8em;
            font-weight: 700;
            margin: 0;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: var(--primary-color); /* Fallback for browsers that don't support background-clip */
            display: inline-block;
        }

        .brand-logo sup {
            font-size: 0.4em;
            font-weight: 500;
        }

        .brand-subtitle {
            font-size: 1em;
            margin: 5px 0;
            color: var(--primary-color);
            opacity: 0.9;
        }

        .upload-container {
            max-width: 800px;
            margin: 0 auto 20px;
            padding: 25px;
            background: var(--background-color);
            border-radius: 16px;
            box-shadow: 0 4px 20px var(--shadow-color);
            transition: transform 0.3s ease;
        }

        .upload-container:hover {
            transform: translateY(-2px);
        }

        .upload-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-box {
            flex: 1;
            padding: 20px;
            background: var(--control-bg);
            border-radius: 12px;
            border: 2px dashed var(--primary-color);
            transition: all 0.3s ease;
        }

        .upload-box:hover {
            border-color: var(--accent-color);
            transform: scale(1.02);
        }

        .upload-box h3 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
            font-weight: 600;
        }

        .slider-container {
            position: relative;
            width: 800px;
            height: 500px;
            overflow: hidden;
            margin: 0 auto;
            background: var(--control-bg);
            border-radius: 16px;
            box-shadow: 0 4px 20px var(--shadow-color);
            touch-action: none; /* Prevent browser handling of touch events */
            user-select: none; /* Prevent text selection */
        }

        .slider-image {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }

        .slider-image.overlay {
            clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%);
            transition: clip-path 0.1s ease-out;
        }

        .slider-handle {
            position: absolute;
            width: 40px;
            height: 40px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: var(--primary-color);
            border: 3px solid white;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 11;
            touch-action: none; /* Prevent browser handling of touch events */
        }

        .slider-handle:active {
            cursor: grabbing;
        }

        .slider {
            position: absolute;
            width: 3px;
            height: 100%;
            left: 50%;
            top: 0;
            background: white;
            transform: translateX(-50%);
            cursor: ew-resize;
            z-index: 10;
        }

        .slider::before {
            content: none;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px var(--shadow-color);
            font-size: 0.9em;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Specific style for export buttons */
        .export-btn {
            padding: 3px 6px !important;
            font-size: 0.8em !important;
            margin: 2px !important;
        }

        .controls-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 25px;
            background: var(--control-bg);
            border-radius: 16px;
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        .controls-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            background: var(--control-bg);
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .install-section {
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border-radius: 10px;
            color: white;
            max-width: 400px;
            text-align: left;
        }

        .install-section h3 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
            padding-left: 10px;
        }

        .install-section p {
            margin: 0 0 15px 0;
            font-size: 0.9em;
            opacity: 0.9;
            padding-left: 10px;
        }

        #installButton {
            margin-left: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: white;
            color: var(--gradient-start);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            border: none;
            font-weight: bold;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .theme-toggle svg {
            width: 20px;
            height: 20px;
            fill: white;
            stroke: white;
            transition: all 0.3s ease;
        }

        .filters-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 5px 10px;
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            background: transparent;
            color: var(--text-color);
            cursor: pointer;
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .ios-install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 14px;
            text-align: center;
            display: none;
            z-index: 1000;
            max-width: 90%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(8px);
        }

        .ios-install-prompt svg {
            width: 24px;
            height: 24px;
            stroke: white;
        }

        #resetButton {
            padding: 3px 6px;
            font-size: 0.8em;
        }

        #resetButton svg {
            width: 14px;
            height: 14px;
        }

        .placeholder-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-color);
            font-size: 1.2em;
            width: 80%;
            z-index: 2;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
        }

        @media (max-width: 850px) {
            .slider-container {
                width: 100%;
                height: 400px;
            }
            .upload-container {
                width: 100%;
                padding: 10px;
            }
            .upload-section {
                flex-direction: column;
                gap: 10px;
            }
            .brand-logo {
                font-size: 2em;
            }
        }
        
        .ios-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--background-color);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 90%;
            width: 320px;
        }
        .ios-prompt-message {
            font-size: 14px;
            text-align: left;
        }
        .ios-prompt-message ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .ios-prompt-message button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            margin-top: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="brand-header">
        <h1 class="brand-logo">R<sup>s</sup></h1>
        <p class="brand-subtitle">by Richdale AI</p>
    </div>

    <div class="upload-container">
        <div class="upload-section">
            <div class="upload-box">
                <h3>Before Image</h3>
                <button id="beforeUpload">Upload</button>
                <input type="file" id="beforeInput" accept="image/*" style="display: none;">
            </div>
            <div class="upload-box">
                <h3>After Image</h3>
                <button id="afterUpload">Upload</button>
                <input type="file" id="afterInput" accept="image/*" style="display: none;">
            </div>
        </div>
    </div>

    <div class="slider-container" id="sliderContainer">
        <div class="placeholder-text">Please upload both images to start comparing</div>
        <img src="" alt="Before" class="slider-image" id="beforeImage" style="display: none;">
        <img src="" alt="After" class="slider-image overlay" id="afterImage" style="display: none;">
        <div class="slider-handle" id="sliderHandle"></div>
        <div class="slider" id="slider"></div>
    </div>

    <button class="theme-toggle" id="themeToggle">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
    </button>

    <button class="install-button" id="installButton">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Install App
    </button>

    <div class="ios-install-prompt" id="iosInstallPrompt">
        <button class="close-button" id="closeIosPrompt">×</button>
        <h3>Install on your iPhone</h3>
        <p>1. Open in Safari</p>
        <p>2. Tap the Share button</p>
        <p>3. Tap "Add to Home Screen"</p>
    </div>

    <div class="controls-container">
        <div class="controls-section">
            <div class="control-group">
                <button id="resetButton" class="control-btn" title="Reset Images">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 1 9 9M3 12h6M3 12l3-3m0 6l-3-3"/>
                    </svg>
                    Reset
                </button>
            </div>
            <div class="control-group">
                <h3>Image Adjustments</h3>
                <label>Brightness
                    <input type="range" id="brightness" min="0" max="200" value="100">
                </label>
                <label>Contrast
                    <input type="range" id="contrast" min="0" max="200" value="100">
                </label>
            </div>
            <div class="control-group">
                <h3>Filters</h3>
                <div class="filters-list">
                    <button class="filter-btn active" data-filter="none">None</button>
                    <button class="filter-btn" data-filter="grayscale">B&W</button>
                    <button class="filter-btn" data-filter="sepia">Sepia</button>
                    <button class="filter-btn" data-filter="invert">Invert</button>
                </div>
            </div>
        </div>
        <div class="controls-section">
            <div class="control-group">
                <h3>Transform</h3>
                <div class="button-group">
                    <button class="btn" id="zoomIn">Zoom In</button>
                    <button class="btn" id="zoomOut">Zoom Out</button>
                    <button class="btn" id="rotateLeft">↺</button>
                    <button class="btn" id="rotateRight">↻</button>
                </div>
            </div>
            <div class="control-group">
                <h3>Export</h3>
                <div class="button-group">
                    <button class="btn export-btn" id="downloadImage">Download Image</button>
                    <button class="btn export-btn" id="createGif">Create Video</button>
                    <button class="btn export-btn" id="shareLink">Share Link</button>
                </div>
            </div>
            <div class="control-group">
                <!-- Add install button -->
                <div class="install-section">
                    <h3>Install Image Compare App</h3>
                    <p>To install, click the install icon in your browser's address bar or menu.</p>
                    <button id="installButton">
                        <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Install App
                    </button>
                    <div id="installInstructions" style="margin-top: 10px; font-size: 0.9em; display: none;">
                        <!-- Installation instructions will be inserted here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@capacitor/core@latest/dist/capacitor.js"></script>
    <script>
        // Initialize Capacitor if available
        let isNative = false;
        try {
            if (typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform()) {
                isNative = true;
                console.log('Running on native platform');
            }
        } catch (e) {
            console.log('Not running on native platform');
        }

        // Get all DOM elements
        const container = document.getElementById('sliderContainer');
        const handle = document.getElementById('sliderHandle');
        const slider = document.getElementById('slider');
        const beforeImage = document.getElementById('beforeImage');
        const afterImage = document.getElementById('afterImage');
        const beforeInput = document.getElementById('beforeInput');
        const afterInput = document.getElementById('afterInput');
        const placeholderText = document.querySelector('.placeholder-text');
        const beforeUploadBtn = document.getElementById('beforeUpload');
        const afterUploadBtn = document.getElementById('afterUpload');
        
        let isDragging = false;

        // Initialize slider position to center (50%)
        window.addEventListener('DOMContentLoaded', () => {
            if (slider && handle && afterImage) {
                slider.style.left = '50%';
                handle.style.left = '50%';
                afterImage.style.clipPath = 'polygon(0 0, 50% 0, 50% 100%, 0 100%)';
                console.log('Slider initialized to center position');
            }
            
            // Initialize event listeners for all buttons
            setupButtonListeners();
        });
        
        // Setup all button listeners in one function
        function setupButtonListeners() {
            // Reset button
            const resetButton = document.getElementById('resetButton');
            if (resetButton) {
                resetButton.addEventListener('click', () => {
                    if (beforeImage) beforeImage.style.display = 'none';
                    if (afterImage) afterImage.style.display = 'none';
                    if (placeholderText) placeholderText.style.display = 'block';
                    if (beforeInput) beforeInput.value = '';
                    if (afterInput) afterInput.value = '';
                    console.log('Reset button clicked, cleared images');
                });
            }
            
            // Download button
            const downloadButton = document.getElementById('downloadImage');
            if (downloadButton) {
                downloadButton.addEventListener('click', () => {
                    console.log('Download button clicked');
                    // Download functionality here
                });
            }
            
            // Other buttons...
        }

        // Initialize slider position
        function updateSliderPosition(x) {
            if (!container || !slider || !handle || !afterImage) return;
            
            // If x is already a normalized position (0-1), use it directly
            let position;
            if (x >= 0 && x <= 1) {
                position = x;
            } else {
                // Otherwise calculate position from pixel coordinates
                const rect = container.getBoundingClientRect();
                position = Math.max(0, Math.min(1, (x - rect.left) / rect.width));
            }
            
            const percentage = position * 100;
            
            // Important: Apply all style changes in a single batch to prevent visual lag
            requestAnimationFrame(() => {
                // The slider line is already centered with transform: translateX(-50%) in CSS
                slider.style.left = `${percentage}%`;
                
                // The handle is centered with transform: translate(-50%, -50%) in CSS
                handle.style.left = `${percentage}%`;
                
                // The image clip needs to match exactly with the slider position
                afterImage.style.clipPath = `polygon(0 0, ${percentage}% 0, ${percentage}% 100%, 0 100%)`;
            });
        }

        // Check if both images are loaded
        function checkImagesLoaded() {
            if (beforeImage && afterImage && 
                beforeImage.src && afterImage.src && 
                beforeImage.src !== window.location.href && 
                afterImage.src !== window.location.href) {
                
                if (placeholderText) {
                    placeholderText.style.display = 'none';
                }
                console.log('Both images loaded, hiding placeholder');
            } else {
                console.log('Images not fully loaded yet');
            }
        }

        // Image upload handling
        function handleFileUpload(file, targetImage) {
            if (!file || !targetImage) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                targetImage.src = e.target.result;
                targetImage.style.display = 'block';
                checkImagesLoaded();
            };
            reader.readAsDataURL(file);
        }

        // Setup event listeners if all elements exist
        if (beforeUploadBtn) {
            beforeUploadBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                console.log('Before upload button clicked');
                
                if (isNative && typeof Capacitor !== 'undefined' && 
                    Capacitor.Plugins && Capacitor.Plugins.Camera) {
                    try {
                        console.log('Using native camera');
                        const image = await Capacitor.Plugins.Camera.getPhoto({
                            quality: 90,
                            allowEditing: false,
                            resultType: 'dataUrl'
                        });
                        
                        beforeImage.src = image.dataUrl;
                        beforeImage.style.display = 'block';
                        checkImagesLoaded();
                    } catch (e) {
                        console.error('Camera error:', e);
                        // Fall back to file input
                        if (beforeInput) beforeInput.click();
                    }
                } else {
                    if (beforeInput) beforeInput.click();
                }
            });
        }

        if (afterUploadBtn) {
            afterUploadBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                console.log('After upload button clicked');
                
                if (isNative && typeof Capacitor !== 'undefined' && 
                    Capacitor.Plugins && Capacitor.Plugins.Camera) {
                    try {
                        console.log('Using native camera');
                        const image = await Capacitor.Plugins.Camera.getPhoto({
                            quality: 90,
                            allowEditing: false,
                            resultType: 'dataUrl'
                        });
                        
                        afterImage.src = image.dataUrl;
                        afterImage.style.display = 'block';
                        checkImagesLoaded();
                    } catch (e) {
                        console.error('Camera error:', e);
                        // Fall back to file input
                        if (afterInput) afterInput.click();
                    }
                } else {
                    if (afterInput) afterInput.click();
                }
            });
        }

        // File input event listeners
        if (beforeInput) {
            beforeInput.addEventListener('change', (e) => {
                console.log('Before input changed', e.target.files);
                if (e.target.files && e.target.files[0]) {
                    handleFileUpload(e.target.files[0], beforeImage);
                }
            });
        }

        if (afterInput) {
            afterInput.addEventListener('change', (e) => {
                console.log('After input changed', e.target.files);
                if (e.target.files && e.target.files[0]) {
                    handleFileUpload(e.target.files[0], afterImage);
                }
            });
        }

        // Slider event listeners
        if (handle) {
            handle.addEventListener('mousedown', (e) => {
                isDragging = true;
                if (document.body) document.body.style.cursor = 'grabbing';
                handle.style.cursor = 'grabbing';
                e.preventDefault();
                console.log('Handle mousedown');
            });

            handle.addEventListener('touchstart', (e) => {
                isDragging = true;
                e.preventDefault();
                console.log('Handle touchstart');
            }, { passive: false });
        }

        if (slider) {
            slider.addEventListener('mousedown', (e) => {
                isDragging = true;
                if (document.body) document.body.style.cursor = 'grabbing';
                updateSliderPosition(e.clientX);
                e.preventDefault();
                console.log('Slider mousedown');
            });

            slider.addEventListener('touchstart', (e) => {
                isDragging = true;
                updateSliderPosition(e.touches[0].clientX);
                e.preventDefault();
                console.log('Slider touchstart');
            }, { passive: false });
        }

        if (container) {
            container.addEventListener('click', (e) => {
                if (e.target === container || e.target === beforeImage || e.target === afterImage) {
                    updateSliderPosition(e.clientX);
                    console.log('Container clicked, updating slider');
                }
            });
        }

        // Global event listeners
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            updateSliderPosition(e.clientX);
            e.preventDefault();
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                if (document.body) document.body.style.cursor = '';
                if (handle) handle.style.cursor = 'grab';
                console.log('Stopped dragging');
            }
        });

        document.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            updateSliderPosition(e.touches[0].clientX);
            e.preventDefault();
        }, { passive: false });

        document.addEventListener('touchend', () => {
            isDragging = false;
            console.log('Touch ended');
        });

        document.addEventListener('touchcancel', () => {
            isDragging = false;
            console.log('Touch cancelled');
        });

        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            themeToggle.innerHTML = isDark ? 
                '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>' : 
                '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';
        }

        themeToggle.addEventListener('click', toggleTheme);

        // Set initial theme
        const savedTheme = localStorage.getItem('theme') || (prefersDarkScheme.matches ? 'dark' : 'light');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-theme');
            themeToggle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';
        }

        // Image Adjustments
        let currentZoom = 1;
        let currentRotation = 0;
        let currentFilter = 'none';
        
        function updateImageStyles() {
            const images = [beforeImage, afterImage];
            const brightness = document.getElementById('brightness').value;
            const contrast = document.getElementById('contrast').value;
            
            images.forEach(img => {
                img.style.transform = `scale(${currentZoom}) rotate(${currentRotation}deg)`;
                img.style.filter = `brightness(${brightness}%) contrast(${contrast}%) ${currentFilter !== 'none' ? currentFilter + '(100%)' : ''}`;
            });
        }

        // Zoom Controls
        document.getElementById('zoomIn').addEventListener('click', () => {
            currentZoom = Math.min(currentZoom + 0.1, 3);
            updateImageStyles();
        });

        document.getElementById('zoomOut').addEventListener('click', () => {
            currentZoom = Math.max(currentZoom - 0.1, 0.5);
            updateImageStyles();
        });

        // Rotation Controls
        document.getElementById('rotateLeft').addEventListener('click', () => {
            currentRotation = (currentRotation - 90) % 360;
            updateImageStyles();
        });

        document.getElementById('rotateRight').addEventListener('click', () => {
            currentRotation = (currentRotation + 90) % 360;
            updateImageStyles();
        });

        // Filter Controls
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelector('.filter-btn.active').classList.remove('active');
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                updateImageStyles();
            });
        });

        // Brightness and Contrast Controls
        document.getElementById('brightness').addEventListener('input', updateImageStyles);
        document.getElementById('contrast').addEventListener('input', updateImageStyles);

        // Export Functions
        document.getElementById('downloadImage').addEventListener('click', () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;

            // Draw the comparison state
            ctx.drawImage(beforeImage, 0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.rect(handle.offsetLeft, 0, canvas.width - handle.offsetLeft, canvas.height);
            ctx.clip();
            ctx.drawImage(afterImage, 0, 0, canvas.width, canvas.height);

            // Download the image
            const link = document.createElement('a');
            link.download = 'comparison.png';
            link.href = canvas.toDataURL();
            link.click();
        });

        document.getElementById('createGif').addEventListener('click', async () => {
            const button = document.getElementById('createGif');
            button.disabled = true;
            button.textContent = 'Creating Video...';

            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const width = Math.min(800, container.offsetWidth);
                const height = Math.min(600, container.offsetHeight);
                canvas.width = width;
                canvas.height = height;

                // Create a MediaRecorder to record the canvas
                const stream = canvas.captureStream(60); // 60 FPS for smoother animation
                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm',
                    videoBitsPerSecond: 8000000 // Higher bitrate for better quality
                });

                const chunks = [];
                mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = 'comparison.webm';
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                    button.disabled = false;
                    button.textContent = 'Create Video';
                };

                mediaRecorder.start();

                // Animate the comparison with fade transition
                const duration = 3000; // 3 seconds in milliseconds
                const startTime = performance.now();

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(1, elapsed / duration);
                    
                    // Draw the before image
                    ctx.drawImage(beforeImage, 0, 0, width, height);
                    
                    // Draw the after image with opacity transition
                    ctx.save();
                    ctx.globalAlpha = progress; // Fade in the after image
                    ctx.drawImage(afterImage, 0, 0, width, height);
                    ctx.restore();

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        setTimeout(() => mediaRecorder.stop(), 500); // Add small delay at the end
                    }
                };

                requestAnimationFrame(animate);
            } catch (error) {
                console.error('Error creating video:', error);
                button.disabled = false;
                button.textContent = 'Create Video';
                alert('Error: ' + error.message);
            }
        });

        document.getElementById('shareLink').addEventListener('click', async () => {
            // For native platforms (Android/iOS with Capacitor)
            if (isNative && typeof Capacitor !== 'undefined' && Capacitor.Plugins && Capacitor.Plugins.Share) {
                try {
                    await Capacitor.Plugins.Share.share({
                        title: 'Image Comparison',
                        text: 'Check out this image comparison!',
                        url: 'https://richdale.ai',
                        dialogTitle: 'Share with friends'
                    });
                } catch (e) {
                    console.error('Native Share error:', e);
                    alert('Sharing not available on this device');
                }
            } 
            // For web browsers that support Web Share API
            else if (typeof navigator !== 'undefined' && navigator.share) {
                try {
                    await navigator.share({
                        title: 'Image Comparison',
                        text: 'Check out this image comparison!',
                        url: window.location.href
                    });
                } catch (e) {
                    console.error('Web Share API error:', e);
                    // Don't show alert on user cancellation
                    if (e.name !== 'AbortError') {
                        alert('Sharing failed. Please try again.');
                    }
                }
            } 
            // Fallback for browsers without Web Share API
            else {
                try {
                    // Create a temporary input to copy the URL
                    const tempInput = document.createElement('input');
                    tempInput.value = window.location.href;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    alert('Link copied to clipboard! You can now paste and share it.');
                } catch (e) {
                    console.error('Clipboard copy error:', e);
                    alert('Sharing not supported on this browser. Please copy the URL manually.');
                }
            }
        });

        // Touch Gestures Support
        let touchStartX = 0;
        let touchStartY = 0;
        let initialZoom = 1;

        container.addEventListener('touchstart', e => {
            if (e.touches.length === 2) {
                // Pinch to zoom
                touchStartX = Math.abs(e.touches[0].clientX - e.touches[1].clientX);
                touchStartY = Math.abs(e.touches[0].clientY - e.touches[1].clientY);
                initialZoom = currentZoom;
            }
        });

        container.addEventListener('touchmove', e => {
            if (e.touches.length === 2) {
                // Calculate zoom
                const currentX = Math.abs(e.touches[0].clientX - e.touches[1].clientX);
                const currentY = Math.abs(e.touches[0].clientY - e.touches[1].clientY);
                
                const initialDistance = Math.sqrt(touchStartX * touchStartX + touchStartY * touchStartY);
                const currentDistance = Math.sqrt(currentX * currentX + currentY * currentY);
                
                currentZoom = Math.min(Math.max(initialZoom * (currentDistance / initialDistance), 0.5), 3);
                updateImageStyles();
                
                e.preventDefault();
            }
        });

        // PWA Installation handling
        let deferredPrompt;
        const installButton = document.getElementById('installButton');
        const installInstructions = document.getElementById('installInstructions');
        const installSection = document.querySelector('.install-section');

        // Function to check if app is installed
        function checkInstallation() {
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                installSection.style.display = 'none';
                return true;
            }
            return false;
        }

        // Show install button if app is installable
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installSection.style.display = 'block';
            console.log('App can be installed, showing install section');
        });

        // Handle successful installation
        window.addEventListener('appinstalled', (evt) => {
            console.log('App was installed');
            installSection.style.display = 'none';
        });

        // Handle the install button click
        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                try {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to the install prompt: ${outcome}`);
                    if (outcome === 'accepted') {
                        installSection.style.display = 'none';
                    }
                } catch (err) {
                    console.error('Error during installation:', err);
                }
                deferredPrompt = null;
            }
        });

        // Special handling for iOS
        const isIOS = () => {
            return [
                'iPad Simulator',
                'iPhone Simulator',
                'iPod Simulator',
                'iPad',
                'iPhone',
                'iPod'
            ].includes(navigator.platform)
            || (navigator.userAgent.includes("Mac") && "ontouchend" in document);
        };

        // Update installation instructions based on platform
        function updateInstallInstructions() {
            if (checkInstallation()) return;

            if (isIOS()) {
                installButton.textContent = 'Add to Home Screen';
                installInstructions.style.display = 'block';
                installInstructions.innerHTML = `
                    <p style="color: white; padding-left: 10px;">To install on iOS:</p>
                    <ol style="text-align: left; margin: 10px 0; padding-right: 20px;">
                        <li>Tap the Share button <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M16 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-2 2h-4v12h4V10zm-6 0H4v12h4V10z"/></svg></li>
                        <li>Select "Add to Home Screen"</li>
                    </ol>
                `;
            } else if (/android/i.test(navigator.userAgent)) {
                installButton.textContent = 'Install App';
                installInstructions.style.display = 'block';
                installInstructions.innerHTML = `
                    <p style="color: white; padding-left: 10px;">To install on Android:</p>
                    <ol style="text-align: left; margin: 10px 0; padding-right: 20px;">
                        <li>Tap the Menu (⋮)</li>
                        <li>Select "Install app" or "Add to Home screen"</li>
                    </ol>
                `;
            } else {
                installButton.textContent = 'Install App';
                installInstructions.style.display = 'block';
                installInstructions.innerHTML = `
                    <p style="color: white; padding-left: 10px;">To install:</p>
                    <ol style="text-align: left; margin: 10px 0; padding-right: 20px;">
                        <li>Look for the install icon in your browser's address bar</li>
                        <li>Or use the browser menu to install</li>
                    </ol>
                `;
            }
        }

        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js', { scope: './' });
                    console.log('ServiceWorker registration successful:', registration);
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('New version available');
                            }
                        });
                    });
                } catch (err) {
                    console.error('ServiceWorker registration failed:', err);
                }
            });
        }

        // Initial setup
        window.addEventListener('load', () => {
            updateInstallInstructions();
        });

        // Add touch event handling
        const sliderContainer = document.querySelector('.slider-container');

        function handleStart(e) {
            isDragging = true;
            slider.style.cursor = 'grabbing';
            // Prevent default to avoid scrolling while sliding
            e.preventDefault();
            
            // Pass the actual pixel position directly
            let clientX;
            if (e.type === 'touchstart') {
                clientX = e.touches[0].clientX;
            } else {
                clientX = e.clientX;
            }
            
            updateSliderPosition(clientX);
        }

        function handleMove(e) {
            if (!isDragging) return;
            
            let clientX;
            if (e.type === 'touchmove') {
                clientX = e.touches[0].clientX;
            } else {
                clientX = e.clientX;
            }

            // Use the container from the updateSliderPosition function for consistency
            const rect = sliderContainer.getBoundingClientRect();
            const position = (clientX - rect.left) / rect.width;
            
            // Call updateSliderPosition with the raw position value
            updateSliderPosition(position);
            e.preventDefault();
        }

        function handleEnd() {
            isDragging = false;
            slider.style.cursor = 'grab';
        }

        // Touch events
        slider.addEventListener('touchstart', handleStart, { passive: false });
        document.addEventListener('touchmove', handleMove, { passive: false });
        document.addEventListener('touchend', handleEnd);

        // Mouse events
        slider.addEventListener('mousedown', handleStart);
        document.addEventListener('mousemove', handleMove);
        document.addEventListener('mouseup', handleEnd);

        // Prevent clicks from repositioning the slider without dragging
        slider.addEventListener('click', (e) => e.preventDefault());

        // Reset button functionality
        const resetButton = document.getElementById('resetButton');
        resetButton.addEventListener('click', () => {
            updateSliderPosition(0.5); // Reset to middle
            // Reset any image adjustments if they exist
            if (window.resetImageAdjustments) {
                window.resetImageAdjustments();
            }
        });
    </script>
</body>
</html>
