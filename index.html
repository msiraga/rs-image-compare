<!DOCTYPE html>
<html>
<head>
    <title>Rs - Image Comparison | Richdale AI</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        :root {
            --primary-color: #00008B;
            --background-color: #ffffff;
            --text-color: #333333;
            --control-bg: #f8f8f8;
            --shadow-color: rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --background-color: #1a1a1a;
            --text-color: #ffffff;
            --control-bg: #2d2d2d;
            --shadow-color: rgba(0,0,0,0.3);
        }

        body {
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background: var(--background-color);
            font-family: Arial, sans-serif;
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .brand-header {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
        }

        .brand-logo {
            font-size: 2.5em;
            font-weight: bold;
            margin: 0;
        }

        .brand-logo sup {
            font-size: 0.5em;
            font-weight: normal;
        }

        .brand-subtitle {
            font-size: 0.9em;
            margin: 5px 0;
            opacity: 0.8;
        }

        .upload-container {
            max-width: 800px;
            margin: 0 auto 20px;
            padding: 20px;
            background: var(--background-color);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .upload-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-box {
            flex: 1;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .upload-box h3 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
        }

        .slider-container {
            position: relative;
            width: 800px;
            height: 500px;
            overflow: hidden;
            margin: 0 auto;
            background: #f8f8f8;
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .slider-image {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .slider-image.overlay {
            clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%);
        }

        .slider-handle {
            position: absolute;
            top: 0;
            left: 50%;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
            cursor: ew-resize;
            z-index: 3;
            transform: translateX(-50%);
        }

        .placeholder-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--primary-color);
            text-align: center;
        }

        .controls-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: var(--control-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .controls-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            padding: 10px;
            border-radius: 4px;
            background: var(--background-color);
        }

        .control-group h3 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
            font-size: 0.9em;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .control-group input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .install-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 24px;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            display: none; /* Hidden by default */
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: transform 0.2s;
        }

        .install-button:hover {
            transform: translateY(-2px);
        }

        .install-button svg {
            width: 24px;
            height: 24px;
        }

        .filters-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 5px 10px;
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            background: transparent;
            color: var(--text-color);
            cursor: pointer;
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
        }

        @media (max-width: 850px) {
            .slider-container {
                width: 100%;
                height: 400px;
            }
            .upload-container {
                width: 100%;
                padding: 10px;
            }
            .upload-section {
                flex-direction: column;
                gap: 10px;
            }
            .brand-logo {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="brand-header">
        <h1 class="brand-logo">R<sup>s</sup></h1>
        <p class="brand-subtitle">by Richdale AI</p>
    </div>

    <div class="upload-container">
        <div class="upload-section">
            <div class="upload-box">
                <h3>Before Image</h3>
                <input type="file" id="beforeInput" accept="image/*">
            </div>
            <div class="upload-box">
                <h3>After Image</h3>
                <input type="file" id="afterInput" accept="image/*">
            </div>
        </div>
    </div>

    <div class="slider-container" id="sliderContainer">
        <div class="placeholder-text">Please upload both images to start comparing</div>
        <img src="" alt="Before" class="slider-image" id="beforeImage" style="display: none;">
        <img src="" alt="After" class="slider-image overlay" id="afterImage" style="display: none;">
        <div class="slider-handle" id="sliderHandle"></div>
    </div>

    <button class="theme-toggle" id="themeToggle">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"/>
            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
    </button>

    <button class="install-button" id="installButton">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Install App
    </button>

    <div class="controls-container">
        <div class="controls-section">
            <div class="control-group">
                <h3>Image Adjustments</h3>
                <label>Brightness
                    <input type="range" id="brightness" min="0" max="200" value="100">
                </label>
                <label>Contrast
                    <input type="range" id="contrast" min="0" max="200" value="100">
                </label>
            </div>
            <div class="control-group">
                <h3>Filters</h3>
                <div class="filters-list">
                    <button class="filter-btn active" data-filter="none">None</button>
                    <button class="filter-btn" data-filter="grayscale">B&W</button>
                    <button class="filter-btn" data-filter="sepia">Sepia</button>
                    <button class="filter-btn" data-filter="invert">Invert</button>
                </div>
            </div>
        </div>
        <div class="controls-section">
            <div class="control-group">
                <h3>Transform</h3>
                <div class="button-group">
                    <button class="btn" id="zoomIn">Zoom In</button>
                    <button class="btn" id="zoomOut">Zoom Out</button>
                    <button class="btn" id="rotateLeft">↺</button>
                    <button class="btn" id="rotateRight">↻</button>
                </div>
            </div>
            <div class="control-group">
                <h3>Export</h3>
                <div class="button-group">
                    <button class="btn" id="downloadImage">Download Image</button>
                    <button class="btn" id="createGif">Create Video</button>
                    <button class="btn" id="shareLink">Share Link</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const container = document.getElementById('sliderContainer');
        const handle = document.getElementById('sliderHandle');
        const beforeImage = document.getElementById('beforeImage');
        const afterImage = document.getElementById('afterImage');
        const beforeInput = document.getElementById('beforeInput');
        const afterInput = document.getElementById('afterInput');
        const placeholderText = document.querySelector('.placeholder-text');
        let isDragging = false;

        function updateSliderPosition(x) {
            const rect = container.getBoundingClientRect();
            const position = Math.max(0, Math.min(1, (x - rect.left) / rect.width));
            const percentage = position * 100;
            
            handle.style.left = `${percentage}%`;
            afterImage.style.clipPath = `polygon(0 0, ${percentage}% 0, ${percentage}% 100%, 0 100%)`;
        }

        function handleImageUpload(file, imgElement) {
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imgElement.src = e.target.result;
                    imgElement.style.display = 'block';
                    checkImagesLoaded();
                };
                reader.readAsDataURL(file);
            }
        }

        function checkImagesLoaded() {
            if (beforeImage.src && afterImage.src) {
                placeholderText.style.display = 'none';
            }
        }

        beforeInput.addEventListener('change', (e) => {
            handleImageUpload(e.target.files[0], beforeImage);
        });

        afterInput.addEventListener('change', (e) => {
            handleImageUpload(e.target.files[0], afterImage);
        });

        handle.addEventListener('mousedown', () => {
            isDragging = true;
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            updateSliderPosition(e.clientX);
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        container.addEventListener('click', (e) => {
            updateSliderPosition(e.clientX);
        });

        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        let isDarkMode = false;

        themeToggle.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
        });

        // Image Adjustments
        let currentZoom = 1;
        let currentRotation = 0;
        let currentFilter = 'none';
        
        function updateImageStyles() {
            const images = [beforeImage, afterImage];
            const brightness = document.getElementById('brightness').value;
            const contrast = document.getElementById('contrast').value;
            
            images.forEach(img => {
                img.style.transform = `scale(${currentZoom}) rotate(${currentRotation}deg)`;
                img.style.filter = `brightness(${brightness}%) contrast(${contrast}%) ${currentFilter !== 'none' ? currentFilter + '(100%)' : ''}`;
            });
        }

        // Zoom Controls
        document.getElementById('zoomIn').addEventListener('click', () => {
            currentZoom = Math.min(currentZoom + 0.1, 3);
            updateImageStyles();
        });

        document.getElementById('zoomOut').addEventListener('click', () => {
            currentZoom = Math.max(currentZoom - 0.1, 0.5);
            updateImageStyles();
        });

        // Rotation Controls
        document.getElementById('rotateLeft').addEventListener('click', () => {
            currentRotation = (currentRotation - 90) % 360;
            updateImageStyles();
        });

        document.getElementById('rotateRight').addEventListener('click', () => {
            currentRotation = (currentRotation + 90) % 360;
            updateImageStyles();
        });

        // Filter Controls
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelector('.filter-btn.active').classList.remove('active');
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                updateImageStyles();
            });
        });

        // Brightness and Contrast Controls
        document.getElementById('brightness').addEventListener('input', updateImageStyles);
        document.getElementById('contrast').addEventListener('input', updateImageStyles);

        // Export Functions
        document.getElementById('downloadImage').addEventListener('click', () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;

            // Draw the comparison state
            ctx.drawImage(beforeImage, 0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.rect(handle.offsetLeft, 0, canvas.width - handle.offsetLeft, canvas.height);
            ctx.clip();
            ctx.drawImage(afterImage, 0, 0, canvas.width, canvas.height);

            // Download the image
            const link = document.createElement('a');
            link.download = 'comparison.png';
            link.href = canvas.toDataURL();
            link.click();
        });

        document.getElementById('createGif').addEventListener('click', async () => {
            const button = document.getElementById('createGif');
            button.disabled = true;
            button.textContent = 'Creating Video...';

            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const width = Math.min(800, container.offsetWidth);
                const height = Math.min(600, container.offsetHeight);
                canvas.width = width;
                canvas.height = height;

                // Create a MediaRecorder to record the canvas
                const stream = canvas.captureStream(60); // 60 FPS for smoother animation
                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm',
                    videoBitsPerSecond: 8000000 // Higher bitrate for better quality
                });

                const chunks = [];
                mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = 'comparison.webm';
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                    button.disabled = false;
                    button.textContent = 'Create Video';
                };

                mediaRecorder.start();

                // Animate the comparison with fade transition
                const duration = 3000; // 3 seconds in milliseconds
                const startTime = performance.now();

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(1, elapsed / duration);
                    
                    // Draw the before image
                    ctx.drawImage(beforeImage, 0, 0, width, height);
                    
                    // Draw the after image with opacity transition
                    ctx.save();
                    ctx.globalAlpha = progress; // Fade in the after image
                    ctx.drawImage(afterImage, 0, 0, width, height);
                    ctx.restore();

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        setTimeout(() => mediaRecorder.stop(), 500); // Add small delay at the end
                    }
                };

                requestAnimationFrame(animate);
            } catch (error) {
                console.error('Error creating video:', error);
                button.disabled = false;
                button.textContent = 'Create Video';
                alert('Error: ' + error.message);
            }
        });

        document.getElementById('shareLink').addEventListener('click', async () => {
            try {
                await navigator.share({
                    title: 'Image Comparison',
                    text: 'Check out this image comparison!',
                    url: window.location.href
                });
            } catch (err) {
                alert('Sharing is not supported on this device/browser');
            }
        });

        // Touch Gestures Support
        let touchStartX = 0;
        let touchStartY = 0;
        let initialZoom = 1;

        container.addEventListener('touchstart', e => {
            if (e.touches.length === 2) {
                // Pinch to zoom
                touchStartX = Math.abs(e.touches[0].clientX - e.touches[1].clientX);
                touchStartY = Math.abs(e.touches[0].clientY - e.touches[1].clientY);
                initialZoom = currentZoom;
            }
        });

        container.addEventListener('touchmove', e => {
            if (e.touches.length === 2) {
                // Calculate zoom
                const currentX = Math.abs(e.touches[0].clientX - e.touches[1].clientX);
                const currentY = Math.abs(e.touches[0].clientY - e.touches[1].clientY);
                
                const initialDistance = Math.sqrt(touchStartX * touchStartX + touchStartY * touchStartY);
                const currentDistance = Math.sqrt(currentX * currentX + currentY * currentY);
                
                currentZoom = Math.min(Math.max(initialZoom * (currentDistance / initialDistance), 0.5), 3);
                updateImageStyles();
                
                e.preventDefault();
            }
        });

        // PWA Installation
        let deferredPrompt;
        const installButton = document.getElementById('installButton');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Show the install button
            installButton.style.display = 'flex';
        });

        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) {
                // The deferred prompt isn't available
                if (/android/i.test(navigator.userAgent)) {
                    // If on Android but can't install, show instructions
                    alert('To install this app:\n1. Open in Chrome\n2. Tap Menu (⋮)\n3. Tap "Install app" or "Add to Home screen"');
                }
                return;
            }
            // Show the install prompt
            deferredPrompt.prompt();
            // Wait for the user to respond to the prompt
            const { outcome } = await deferredPrompt.userChoice;
            // We no longer need the prompt. Clear it up
            deferredPrompt = null;
            // Hide the install button
            installButton.style.display = 'none';
        });

        // Hide the install button if the app is already installed
        window.addEventListener('appinstalled', () => {
            installButton.style.display = 'none';
            deferredPrompt = null;
        });

        // Check if already installed
        if (window.matchMedia('(display-mode: standalone)').matches) {
            installButton.style.display = 'none';
        }
    </script>
</body>
</html>
