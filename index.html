<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Richdale AI - Image Compare</title>
    <meta name="theme-color" content="#4A90E2">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <style>
        :root {
            --primary-color: #4A90E2;
            --accent-color: #FF6B6B;
            --background-color: #ffffff;
            --text-color: #2C3E50;
            --control-bg: #F7F9FC;
            --shadow-color: rgba(74, 144, 226, 0.1);
            --gradient-start: #4A90E2;
            --gradient-end: #357ABD;
        }

        [data-theme="dark"] {
            --background-color: #1a1a1a;
            --text-color: #ffffff;
            --control-bg: #2d2d2d;
            --shadow-color: rgba(74, 144, 226, 0.2);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background: var(--background-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .brand-header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .brand-logo {
            font-size: 2.8em;
            font-weight: 700;
            margin: 0;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: var(--primary-color); /* Fallback for browsers that don't support background-clip */
            display: inline-block;
        }

        .brand-logo sup {
            font-size: 0.4em;
            font-weight: 500;
        }

        .brand-subtitle {
            font-size: 1em;
            margin: 5px 0;
            color: var(--primary-color);
            opacity: 0.9;
        }

        .upload-container {
            max-width: 800px;
            margin: 0 auto 20px;
            padding: 25px;
            background: var(--background-color);
            border-radius: 16px;
            box-shadow: 0 4px 20px var(--shadow-color);
            transition: transform 0.3s ease;
        }

        .upload-container:hover {
            transform: translateY(-2px);
        }

        .upload-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-box {
            flex: 1;
            padding: 20px;
            background: var(--control-bg);
            border-radius: 12px;
            border: 2px dashed var(--primary-color);
            transition: all 0.3s ease;
        }

        .upload-box:hover {
            border-color: var(--accent-color);
            transform: scale(1.02);
        }

        .upload-box h3 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
            font-weight: 600;
        }

        .slider-container {
            position: relative;
            width: 800px;
            height: 500px;
            overflow: hidden;
            margin: 0 auto;
            background: var(--control-bg);
            border-radius: 16px;
            box-shadow: 0 4px 20px var(--shadow-color);
            touch-action: none;
        }

        .slider-image {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }

        .slider-image.overlay {
            clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%);
            transition: clip-path 0.1s ease-out;
        }

        .slider-handle {
            position: absolute;
            top: 0;
            left: 50%;
            width: 3px;
            height: 100%;
            background: var(--primary-color);
            cursor: ew-resize;
            z-index: 3;
            transform: translateX(-50%);
        }

        .slider {
            position: absolute;
            width: 44px;
            height: 44px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: var(--primary-color);
            border: 3px solid white;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
        }

        .slider:active {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.1);
        }

        .slider::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg>') no-repeat center;
            background-size: contain;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .controls-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 25px;
            background: var(--control-bg);
            border-radius: 16px;
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        .controls-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            padding: 15px;
            border-radius: 12px;
            background: var(--background-color);
            transition: transform 0.3s ease;
        }

        .control-group:hover {
            transform: translateY(-2px);
        }

        .control-group h3 {
            margin: 0 0 12px 0;
            color: var(--primary-color);
            font-size: 1em;
            font-weight: 600;
        }

        input[type="range"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: var(--control-bg);
            border-radius: 3px;
            outline: none;
            touch-action: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--primary-color);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        input[type="range"]::-ms-thumb {
            width: 18px;
            height: 18px;
            background: var(--primary-color);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            background: var(--control-bg);
            border: none;
            border-radius: 3px;
        }

        input[type="range"]::-moz-range-track {
            width: 100%;
            height: 6px;
            background: var(--control-bg);
            border: none;
            border-radius: 3px;
        }

        input[type="range"]::-ms-track {
            width: 100%;
            height: 6px;
            background: var(--control-bg);
            border: none;
            border-radius: 3px;
        }

        input[type="range"]::-webkit-slider-thumb:hover,
        input[type="range"]::-moz-range-thumb:hover,
        input[type="range"]::-ms-thumb:hover {
            transform: scale(1.2);
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .theme-toggle:before {
            content: "‚òÄÔ∏è";
        }

        [data-theme="dark"] .theme-toggle:before {
            content: "üåô";
        }

        .install-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 24px;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: transform 0.2s, background-color 0.2s;
            z-index: 1000;
        }

        .install-button:hover {
            transform: translateY(-2px);
            background-color: #357ABD;
        }

        .install-button svg {
            width: 24px;
            height: 24px;
        }

        .filters-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 5px 10px;
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            background: transparent;
            color: var(--text-color);
            cursor: pointer;
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .ios-install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 14px;
            text-align: center;
            display: none;
            z-index: 1000;
            max-width: 90%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(8px);
        }

        .ios-install-prompt svg {
            width: 24px;
            height: 24px;
            stroke: white;
        }

        @media (max-width: 850px) {
            .slider-container {
                width: 100%;
                height: 400px;
            }
            .upload-container {
                width: 100%;
                padding: 10px;
            }
            .upload-section {
                flex-direction: column;
                gap: 10px;
            }
            .brand-logo {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="brand-header">
        <h1 class="brand-logo">R<sup>s</sup></h1>
        <p class="brand-subtitle">by Richdale AI</p>
    </div>

    <div class="upload-container">
        <div class="upload-section">
            <div class="upload-box">
                <h3>Before Image</h3>
                <button id="beforeUpload">Upload</button>
                <input type="file" id="beforeInput" accept="image/*" style="display: none;">
            </div>
            <div class="upload-box">
                <h3>After Image</h3>
                <button id="afterUpload">Upload</button>
                <input type="file" id="afterInput" accept="image/*" style="display: none;">
            </div>
        </div>
    </div>

    <div class="slider-container" id="sliderContainer">
        <div class="placeholder-text">Please upload both images to start comparing</div>
        <img src="" alt="Before" class="slider-image" id="beforeImage" style="display: none;">
        <img src="" alt="After" class="slider-image overlay" id="afterImage" style="display: none;">
        <div class="slider-handle" id="sliderHandle"></div>
        <div class="slider" id="slider"></div>
    </div>

    <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark/light mode"></button>

    <button class="install-button" id="installButton">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Install App
    </button>

    <div class="ios-install-prompt" id="iosInstallPrompt">
        <button class="close-button" id="closeIosPrompt">√ó</button>
        <h3>Install on your iPhone</h3>
        <p>1. Open in Safari</p>
        <p>2. Tap the Share button</p>
        <p>3. Tap "Add to Home Screen"</p>
    </div>

    <div class="controls-container">
        <div class="controls-section">
            <div class="control-group">
                <button id="resetButton" class="control-btn" title="Reset Images">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 1 9 9M3 12h6M3 12l3-3m0 6l-3-3"/>
                    </svg>
                    Reset
                </button>
            </div>
            <div class="control-group">
                <h3>Image Adjustments</h3>
                <label>Brightness
                    <input type="range" id="brightness" min="0" max="200" value="100">
                </label>
                <label>Contrast
                    <input type="range" id="contrast" min="0" max="200" value="100">
                </label>
            </div>
            <div class="control-group">
                <h3>Filters</h3>
                <div class="filters-list">
                    <button class="filter-btn active" data-filter="none">None</button>
                    <button class="filter-btn" data-filter="grayscale">B&W</button>
                    <button class="filter-btn" data-filter="sepia">Sepia</button>
                    <button class="filter-btn" data-filter="invert">Invert</button>
                </div>
            </div>
        </div>
        <div class="controls-section">
            <div class="control-group">
                <h3>Transform</h3>
                <div class="button-group">
                    <button class="btn" id="zoomIn">Zoom In</button>
                    <button class="btn" id="zoomOut">Zoom Out</button>
                    <button class="btn" id="rotateLeft">‚Ü∫</button>
                    <button class="btn" id="rotateRight">‚Üª</button>
                </div>
            </div>
            <div class="control-group">
                <h3>Export</h3>
                <div class="button-group">
                    <button class="btn" id="downloadImage">Download Image</button>
                    <button class="btn" id="createGif">Create Video</button>
                    <button class="btn" id="shareLink">Share Link</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@capacitor/core@latest/dist/capacitor.js"></script>
    <script>
        // Initialize Capacitor if available
        let isNative = false;
        try {
            if (typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform()) {
                isNative = true;
                console.log('Running on native platform');
            }
        } catch (e) {
            console.log('Not running on native platform');
        }

        const container = document.getElementById('sliderContainer');
        const handle = document.getElementById('sliderHandle');
        const beforeImage = document.getElementById('beforeImage');
        const afterImage = document.getElementById('afterImage');
        const beforeInput = document.getElementById('beforeInput');
        const afterInput = document.getElementById('afterInput');
        const placeholderText = document.querySelector('.placeholder-text');
        let isDragging = false;

        function updateSliderPosition(x) {
            const rect = container.getBoundingClientRect();
            const position = Math.max(0, Math.min(1, (x - rect.left) / rect.width));
            const percentage = position * 100;
            
            handle.style.left = `${percentage}%`;
            afterImage.style.clipPath = `polygon(0 0, ${percentage}% 0, ${percentage}% 100%, 0 100%)`;
        }

        function handleImageUpload(file, imgElement) {
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imgElement.src = e.target.result;
                    imgElement.style.display = 'block';
                    checkImagesLoaded();
                };
                reader.readAsDataURL(file);
            }
        }

        function checkImagesLoaded() {
            if (beforeImage.src && afterImage.src) {
                placeholderText.style.display = 'none';
            }
        }

        beforeInput.addEventListener('change', (e) => {
            handleImageUpload(e.target.files[0], beforeImage);
        });

        afterInput.addEventListener('change', (e) => {
            handleImageUpload(e.target.files[0], afterImage);
        });

        handle.addEventListener('mousedown', () => {
            isDragging = true;
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            updateSliderPosition(e.clientX);
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        container.addEventListener('click', (e) => {
            updateSliderPosition(e.clientX);
        });

        // Add native camera support
        document.getElementById('beforeUpload').addEventListener('click', async (e) => {
            if (isNative && typeof Capacitor.Plugins.Camera !== 'undefined') {
                try {
                    const image = await Capacitor.Plugins.Camera.getPhoto({
                        quality: 90,
                        allowEditing: false,
                        resultType: 'dataUrl'
                    });
                    
                    beforeImage.src = image.dataUrl;
                    beforeImage.onload = checkImagesLoaded;
                } catch (e) {
                    console.error('Camera error:', e);
                    // Fall back to file input
                    beforeInput.click();
                }
            } else {
                beforeInput.click();
            }
        });

        document.getElementById('afterUpload').addEventListener('click', async (e) => {
            if (isNative && typeof Capacitor.Plugins.Camera !== 'undefined') {
                try {
                    const image = await Capacitor.Plugins.Camera.getPhoto({
                        quality: 90,
                        allowEditing: false,
                        resultType: 'dataUrl'
                    });
                    
                    afterImage.src = image.dataUrl;
                    afterImage.onload = checkImagesLoaded;
                } catch (e) {
                    console.error('Camera error:', e);
                    // Fall back to file input
                    afterInput.click();
                }
            } else {
                afterInput.click();
            }
        });

        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        
        // Set initial theme based on saved preference
        if (isDarkMode) {
            document.documentElement.setAttribute('data-theme', 'dark');
        }

        themeToggle.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            localStorage.setItem('darkMode', isDarkMode);
        });

        // Image Adjustments
        let currentZoom = 1;
        let currentRotation = 0;
        let currentFilter = 'none';
        
        function updateImageStyles() {
            const images = [beforeImage, afterImage];
            const brightness = document.getElementById('brightness').value;
            const contrast = document.getElementById('contrast').value;
            
            images.forEach(img => {
                img.style.transform = `scale(${currentZoom}) rotate(${currentRotation}deg)`;
                img.style.filter = `brightness(${brightness}%) contrast(${contrast}%) ${currentFilter !== 'none' ? currentFilter + '(100%)' : ''}`;
            });
        }

        // Zoom Controls
        document.getElementById('zoomIn').addEventListener('click', () => {
            currentZoom = Math.min(currentZoom + 0.1, 3);
            updateImageStyles();
        });

        document.getElementById('zoomOut').addEventListener('click', () => {
            currentZoom = Math.max(currentZoom - 0.1, 0.5);
            updateImageStyles();
        });

        // Rotation Controls
        document.getElementById('rotateLeft').addEventListener('click', () => {
            currentRotation = (currentRotation - 90) % 360;
            updateImageStyles();
        });

        document.getElementById('rotateRight').addEventListener('click', () => {
            currentRotation = (currentRotation + 90) % 360;
            updateImageStyles();
        });

        // Filter Controls
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelector('.filter-btn.active').classList.remove('active');
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                updateImageStyles();
            });
        });

        // Brightness and Contrast Controls
        document.getElementById('brightness').addEventListener('input', updateImageStyles);
        document.getElementById('contrast').addEventListener('input', updateImageStyles);

        // Export Functions
        document.getElementById('downloadImage').addEventListener('click', () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;

            // Draw the comparison state
            ctx.drawImage(beforeImage, 0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.rect(handle.offsetLeft, 0, canvas.width - handle.offsetLeft, canvas.height);
            ctx.clip();
            ctx.drawImage(afterImage, 0, 0, canvas.width, canvas.height);

            // Download the image
            const link = document.createElement('a');
            link.download = 'comparison.png';
            link.href = canvas.toDataURL();
            link.click();
        });

        document.getElementById('createGif').addEventListener('click', async () => {
            const button = document.getElementById('createGif');
            button.disabled = true;
            button.textContent = 'Creating Video...';

            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const width = Math.min(800, container.offsetWidth);
                const height = Math.min(600, container.offsetHeight);
                canvas.width = width;
                canvas.height = height;

                // Create a MediaRecorder to record the canvas
                const stream = canvas.captureStream(60); // 60 FPS for smoother animation
                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm',
                    videoBitsPerSecond: 8000000 // Higher bitrate for better quality
                });

                const chunks = [];
                mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = 'comparison.webm';
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                    button.disabled = false;
                    button.textContent = 'Create Video';
                };

                mediaRecorder.start();

                // Animate the comparison with fade transition
                const duration = 3000; // 3 seconds in milliseconds
                const startTime = performance.now();

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(1, elapsed / duration);
                    
                    // Draw the before image
                    ctx.drawImage(beforeImage, 0, 0, width, height);
                    
                    // Draw the after image with opacity transition
                    ctx.save();
                    ctx.globalAlpha = progress; // Fade in the after image
                    ctx.drawImage(afterImage, 0, 0, width, height);
                    ctx.restore();

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        setTimeout(() => mediaRecorder.stop(), 500); // Add small delay at the end
                    }
                };

                requestAnimationFrame(animate);
            } catch (error) {
                console.error('Error creating video:', error);
                button.disabled = false;
                button.textContent = 'Create Video';
                alert('Error: ' + error.message);
            }
        });

        document.getElementById('shareLink').addEventListener('click', async () => {
            if (isNative && typeof Capacitor.Plugins.Share !== 'undefined') {
                try {
                    await Capacitor.Plugins.Share.share({
                        title: 'Image Comparison',
                        text: 'Check out this image comparison!',
                        url: 'https://richdale.ai',
                        dialogTitle: 'Share with friends'
                    });
                } catch (e) {
                    console.error('Share error:', e);
                    alert('Sharing not available');
                }
            } else if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Image Comparison',
                        text: 'Check out this image comparison!',
                        url: window.location.href
                    });
                } catch (e) {
                    console.error('Web Share API error:', e);
                    alert('Sharing not available');
                }
            } else {
                alert('Sharing not supported on this device');
            }
        });

        // Touch Gestures Support
        let touchStartX = 0;
        let touchStartY = 0;
        let initialZoom = 1;

        container.addEventListener('touchstart', e => {
            if (e.touches.length === 2) {
                // Pinch to zoom
                touchStartX = Math.abs(e.touches[0].clientX - e.touches[1].clientX);
                touchStartY = Math.abs(e.touches[0].clientY - e.touches[1].clientY);
                initialZoom = currentZoom;
            }
        });

        container.addEventListener('touchmove', e => {
            if (e.touches.length === 2) {
                // Calculate zoom
                const currentX = Math.abs(e.touches[0].clientX - e.touches[1].clientX);
                const currentY = Math.abs(e.touches[0].clientY - e.touches[1].clientY);
                
                const initialDistance = Math.sqrt(touchStartX * touchStartX + touchStartY * touchStartY);
                const currentDistance = Math.sqrt(currentX * currentX + currentY * currentY);
                
                currentZoom = Math.min(Math.max(initialZoom * (currentDistance / initialDistance), 0.5), 3);
                updateImageStyles();
                
                e.preventDefault();
            }
        });

        // PWA Installation
        let deferredPrompt;
        const installButton = document.getElementById('installButton');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Show the install button
            installButton.style.display = 'flex';
        });

        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) {
                if (/android/i.test(navigator.userAgent)) {
                    alert('To install this app:\n1. Open in Chrome\n2. Tap Menu (‚ãÆ)\n3. Tap "Install app" or "Add to Home screen"');
                } else if (isIOS()) {
                    showIOSPrompt();
                }
                return;
            }
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
            installButton.style.display = 'none';
        });

        // Restore normal install button behavior
        window.addEventListener('appinstalled', () => {
            installButton.style.display = 'none';
            deferredPrompt = null;
        });

        // Check if already installed
        if (window.matchMedia('(display-mode: standalone)').matches) {
            installButton.style.display = 'none';
        }

        // More reliable iOS detection
        const isIOS = () => {
            const ua = navigator.userAgent.toLowerCase();
            return (
                /iphone|ipad|ipod/.test(ua) ||              // iOS devices
                (ua.includes('mac') && 'ontouchend' in document)  // iPad with desktop mode
            ) && !window.MSStream;  // Exclude IE11
        };

        // iOS installation prompt
        const iosPrompt = document.getElementById('iosInstallPrompt');
        const closeIosPrompt = document.getElementById('closeIosPrompt');
        let promptShown = false;  // Prevent multiple prompts

        // Show iOS prompt if conditions are met
        const showIOSPrompt = () => {
            if (!promptShown && 
                isIOS() && 
                !window.matchMedia('(display-mode: standalone)').matches && 
                !localStorage.getItem('iosPromptDismissed')) {
                iosPrompt.style.display = 'block';
                promptShown = true;
            }
        };

        // Delay prompt for better UX
        if (document.readyState === 'complete') {
            setTimeout(showIOSPrompt, 2000);
        } else {
            window.addEventListener('load', () => {
                setTimeout(showIOSPrompt, 2000);
            });
        }

        closeIosPrompt.addEventListener('click', () => {
            iosPrompt.style.display = 'none';
            localStorage.setItem('iosPromptDismissed', 'true');
            promptShown = false;
        });

        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js', { scope: './' })
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New update available
                                    if (confirm('A new version is available! Would you like to update?')) {
                                        newWorker.postMessage({ type: 'skipWaiting' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });

                // Handle updates when the page reloads
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (!refreshing) {
                        refreshing = true;
                        window.location.reload();
                    }
                });
            });
        }

        // Add touch event handling
        const slider = document.getElementById('slider');
        const sliderContainer = document.querySelector('.slider-container');

        function handleStart(e) {
            isDragging = true;
            slider.style.cursor = 'grabbing';
            // Prevent default to avoid scrolling while sliding
            e.preventDefault();
        }

        function handleMove(e) {
            if (!isDragging) return;
            
            let clientX;
            if (e.type === 'touchmove') {
                clientX = e.touches[0].clientX;
            } else {
                clientX = e.clientX;
            }

            const rect = sliderContainer.getBoundingClientRect();
            let position = (clientX - rect.left) / rect.width;
            position = Math.max(0, Math.min(1, position));
            
            updateSliderPosition(position);
        }

        function handleEnd() {
            isDragging = false;
            slider.style.cursor = 'grab';
        }

        // Touch events
        slider.addEventListener('touchstart', handleStart, { passive: false });
        document.addEventListener('touchmove', handleMove, { passive: false });
        document.addEventListener('touchend', handleEnd);

        // Mouse events
        slider.addEventListener('mousedown', handleStart);
        document.addEventListener('mousemove', handleMove);
        document.addEventListener('mouseup', handleEnd);

        // Reset button functionality
        const resetButton = document.getElementById('resetButton');
        resetButton.addEventListener('click', () => {
            updateSliderPosition(0.5); // Reset to middle
            // Reset any image adjustments if they exist
            if (window.resetImageAdjustments) {
                window.resetImageAdjustments();
            }
        });

        function updateSliderPosition(position) {
            slider.style.left = `${position * 100}%`;
            document.querySelector('.before').style.width = `${position * 100}%`;
        }
    </script>
</body>
</html>
